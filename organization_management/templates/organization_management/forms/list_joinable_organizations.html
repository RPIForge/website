{% load static %}
{% load js %}

{% block custom_styles %}
    <link rel="stylesheet" type="text/css" href="{% static 'forge/css/forms/join_organization.css' %}">
{% endblock custom_styles %}


<html>
	<head>
		<link rel="stylesheet" type="text/css" href="{% static 'forge/css/dyn/list.css' %}" />
		<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
		<script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js" crossorigin="anonymous"></script>
		<script src="https://cdn.datatables.net/buttons/1.6.1/js/dataTables.buttons.min.js"></script>
		<script src="https://cdn.datatables.net/buttons/1.6.1/js/buttons.flash.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
		<script src="https://cdn.datatables.net/buttons/1.6.1/js/buttons.html5.min.js"></script>
		<script src="https://cdn.datatables.net/buttons/1.6.1/js/buttons.print.min.js"></script>
		<script src="//cdn.datatables.net/plug-ins/1.10.21/sorting/datetime-moment.js"></script>
		<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css" />
		<title>{{ page_title }}</title>
		{% include "forge/components/fonts.html" %} <!-- May not be necessary if this is only being loaded in frames. -->
	</head>

	<body>
		<table id="data" class="display">
			<thead>
			<tr>
			{% for header in table_headers %}
				<th>{{ header }}</th>
			{% endfor %}
				<th>Actions</th>
			</tr>
			</thead>

			<tbody>
			{% for row in table_rows %}
			<tr>
                {% for item in row %}
                    <td>{{ item }}</td>
                {% endfor %}
				<td>
					<a class="edit_link" onclick="join_org({{ forloop.counter0 }})"><i class="fa fa-sign-in" title="Join"></i></a>
					<!-- <i class="fas fa-eye"></i> to view usages etc -->
				</td>
			</tr>
			{% endfor %}
			</tbody>
		</table>

		<div id="confirmation">

            <p class="title" id="machine_selection_title"><strong>Machine Selection</strong></p>

            <select id="machine_selection">
                <option value selected disabled>Select a Machine</option>
                {% for machine_type, machines in available_machines.items %}
                    <optgroup label="{{ machine_type }}">
                    {% for machine_name in machines %}
                        <option value="{{ machine_name }}">{{ machine_name }}</option>
                    {% endfor %}
                    </optgroup>
                {% endfor %}
            </select>

            <br /><br />

            <button id="available_next">Next</button>
        </div>

		<script>
			$(document).ready( function () {
					$('#data').DataTable({
						"aLengthMenu": [[20, 50, 100, -1], [20, 50, 100, "All"]],
						"iDisplayLength": 20,
						"dom": 'Bfrtip',
                        "columnDefs": [
                            { "type": "datetime-moment", targets: 1 }
                        ],
						"buttons": [
							'copy', 'csv', 'excel', 'pdf', 'print'
						]
					});
			} );

			const table_rows = {{table_rows|js}};	
			const org_ids = {{org_ids|js}};	

			function join_org(id) {
				const row = table_rows[id]
				const org_id = org_ids[row[0]]
				const json = {
					org_id: org_id
				}

				$.ajax({
			        url: 'api/organization/join_organization',
			        type: 'post',
			        dataType: 'json',
			        contentType: 'application/json',
			        data: JSON.stringify(json)
			    }).done(function(data, statusText, xhr){
				  var status = xhr.status;                //200
				  console.log(status)
				});
			}

		</script>
	</body>
</html>
