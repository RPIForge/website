{% load static %}
{% load js %}

{% block custom_styles %}
    <link rel="stylesheet" type="text/css" href="{% static 'forge/css/forms/join_organization.css' %}">
{% endblock custom_styles %}


<html>
	<head>
		<link rel="stylesheet" type="text/css" href="{% static 'forge/css/dyn/list.css' %}" />
		<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
		<script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js" crossorigin="anonymous"></script>
		<script src="https://cdn.datatables.net/buttons/1.6.1/js/dataTables.buttons.min.js"></script>
		<script src="https://cdn.datatables.net/buttons/1.6.1/js/buttons.flash.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
		<script src="https://cdn.datatables.net/buttons/1.6.1/js/buttons.html5.min.js"></script>
		<script src="https://cdn.datatables.net/buttons/1.6.1/js/buttons.print.min.js"></script>
		<script src="//cdn.datatables.net/plug-ins/1.10.21/sorting/datetime-moment.js"></script>
		<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css" />
		<title>{{ page_title }}</title>
		{% include "forge/components/fonts.html" %} <!-- May not be necessary if this is only being loaded in frames. -->
	</head>

	<body>
		<table id="data" class="display">
			<thead>
			<tr>
			{% for header in table_headers %}
				<th>{{ header }}</th>
			{% endfor %}
				<th>Actions</th>
			</tr>
			</thead>

			<tbody>
			{% for row in table_rows %}
			<tr>
                {% for item in row %}
                    <td>{{ item }}</td>
                {% endfor %}
				<td>
					<a class="edit_link" onclick="join_org({{ forloop.counter0 }})"><i class="fa fa-sign-in" title="Join"></i></a>
					<!-- <i class="fas fa-eye"></i> to view usages etc -->
				</td>
			</tr>
			{% endfor %}
			</tbody>
		</table>

        <div id="confirmation" hidden>
            <p class="no_margin" id="title"><strong>Join Organization:</strong></p><br />

            <p class="no_margin" id="text">You are about to join the ---- organizaton. Your busar account will be charged ----. If you have any questions please email William He at hew8@rpi.edus.</p><br /><br />

            <button id="accept_policy">Accept and Continue</button>
        </div>
		<script>
			function getCookie(name) {
			    let cookieValue = null;
			    if (document.cookie && document.cookie !== '') {
			        const cookies = document.cookie.split(';');
			        for (let i = 0; i < cookies.length; i++) {
			            const cookie = cookies[i].trim();
			            // Does this cookie string begin with the name we want?
			            if (cookie.substring(0, name.length + 1) === (name + '=')) {
			                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
			                break;
			            }
			        }
			    }
			    return cookieValue;
			}
			const csrftoken = getCookie('csrftoken');
		</script>
		<script>
			$(document).ready( function () {
					$('#data').DataTable({
						"aLengthMenu": [[20, 50, 100, -1], [20, 50, 100, "All"]],
						"iDisplayLength": 20,
						"dom": 'Bfrtip',
                        "columnDefs": [
                            { "type": "datetime-moment", targets: 1 }
                        ],
						"buttons": [
							'copy', 'csv', 'excel', 'pdf', 'print'
						],
						"language": {
					      "emptyTable": "No organizations are available to join."
					    }
					});
			} );

			const table_rows = {{table_rows|js}};	
			const org_ids = {{org_ids|js}};	

			function join_org(id) {
				const row = table_rows[id]
				const org_id = org_ids[row[0]]
				const json = {
					org_id: org_id
				}

				const request = new Request(
				    '/api/organization/join_organization',
				    {headers: {'X-CSRFToken': csrftoken}}
				);

				fetch(request, {
				    method: 'POST',
				    mode: 'same-origin',  // Do not send CSRF token to another domain.
					dataType: 'json',
			        contentType: 'application/json',
			        body: JSON.stringify(json)
				}).then(function(response) {
				    console.log(response)
				});
			}

		</script>
	</body>
</html>
